!function(){function t(t){return t.length?d3.keys(t[0]).sort():[]}function n(){d3.event.stopPropagation(),d3.event.preventDefault()}function e(t){return t.name}function r(t){return t[0].categories.reduce(function(t,n){return t+n.count},0)}function o(t,n){return function(e,r){var o=this.textContent=t(e,r),a=n(e,r);if(this.getComputedTextLength()<a)return o;this.textContent="…"+o;for(var i,c=0,s=o.length+1;s>c;){var u=c+s>>1;(i=this.getSubStringLength(0,u))<a?c=u+1:s=u}return c>1?o.substr(0,c-2)+"…":""}}function a(t,n,e,r){i(t);for(var o=n.length,a=e.length,c=0;o>c;c++){for(var s=n[c],u=+r(s,c),d=t,l=0;a>l;l++){var f=e[l],h=s[f],p=d.children;d.count+=u,d=p.hasOwnProperty(h)?p[h]:p[h]={children:l===a-1?null:{},count:0,parent:d,dimension:f,name:h}}d.count+=u}return t}function i(t){if(t.count=0,t.children)for(var n in t.children)i(t.children[n])}function c(t){return t}function s(t){return"translate(0,"+t.y+")"}function u(t){for(var n=t.count,e=[];t.parent;)t.name&&e.unshift(t.name),t=t.parent;return e.join(" → ")+"<br>"+f(n)+" ("+l(n/t.count)+")"}function d(t){return t.name+"<br>"+f(t.count)+" ("+l(t.count/t.dimension.count)+")"}d3.parsets=function(){function i(t){t.each(function(t,i){function u(){var t=d3.interpolateNumber(A,N);return function(n){A=t(n),B.attr("d",v)}}function d(){var o=G.selectAll("g.dimension"),i={};o.each(function(t){i[t.name]=t}),J.forEach(function(t){i.hasOwnProperty(t)||(i[t]={name:t,categories:[]}),K.push(i[t])}),K.sort(w),G.select(".ribbon").selectAll("path").each(function(t){for(var n=t.path.split("\x00"),e=Q,r=n.length-1,o=0;r>o;o++){var a=n[o];e=e.children.hasOwnProperty(a)?e.children[a]:e.children[a]={children:{},count:0}}e.children[t.name]=t}),Q=a(Q,t,K.map(e),E),i=K.map(function(t){var n={};return t.categories.forEach(function(t){n[t.name]=t}),n}),function f(t,n){if(t.children){var e=K[n],r=i[n];for(var o in t.children)r.hasOwnProperty(o)||e.categories.push(r[o]={name:o}),f(t.children[o],n+1)}}(Q,0),H.domain([]).range(d3.range(K[0].categories.length)),F=x(Q,K,H),q=r(K),K.forEach(function(t){t.count=q}),o=o.data(K,e);var u=o.enter().append("g").attr("class","dimension").attr("transform",function(t){return"translate(0,"+t.y+")"}).on("mousedown.parsets",n);o.each(function(t){t.y0=t.y,t.categories.forEach(function(t){t.x0=t.x})}),u.append("rect").attr("width",C).attr("y",-45).attr("height",45);var d=u.append("text").attr("class","dimension").attr("transform","translate(0,-25)");d.append("tspan").attr("class","name").text(l),d.append("tspan").attr("class","sort alpha").attr("dx","2em").text("alpha »").on("mousedown.parsets",n),d.append("tspan").attr("class","sort size").attr("dx","2em").text("size »").on("mousedown.parsets",n),o.call(d3.behavior.drag().origin(c).on("dragstart",function(t){I=!0,t.y0=t.y}).on("drag",function(n){n.y0=n.y=d3.event.y;for(var i=1;i<K.length;i++)if(P*K[i].y<P*K[i-1].y){K.sort(w),J=K.map(e),H.domain([]).range(d3.range(K[0].categories.length)),F=x(Q=a({children:{},count:0},t,J,E),K,H),q=r(K),G.selectAll(".ribbon, .ribbon-mouse").selectAll("path").remove(),b(),Z(o),o.transition().duration(_).attr("transform",s).tween("ribbon",D),k.sortDimensions();break}d3.select(this).attr("transform","translate(0,"+n.y+")").transition(),B.filter(function(t){return t.source.dimension===n||t.target.dimension===n}).attr("d",v)}).on("dragend",function(t){I=!1,T();var n=45,e=(P-n-2)/(K.length-1);K.forEach(function(t,r){t.y=n+r*e}),m(d3.select(this)).attr("transform","translate(0,"+t.y+")").tween("ribbon",D)})),o.select("text").select("tspan.sort.alpha").on("click.parsets",h("alpha",function(t,n){return t.name<n.name?1:-1},o)),o.select("text").select("tspan.sort.size").on("click.parsets",h("size",function(t,n){return t.count-n.count},o)),o.transition().duration(_).attr("transform",function(t){return"translate(0,"+t.y+")"}).tween("ribbon",D),o.exit().remove(),Z(o),b()}function h(t,n,e){return function(r){var o=this.__direction=-(this.__direction||1);d3.select(this).text(o>0?t+" »":"« "+t),r.categories.sort(function(){return o*n.apply(this,arguments)}),F=x(Q,K,H),Z(e),b(),k.sortCategories()}}function b(){B=G.select(".ribbon").selectAll("path").data(F,function(t){return t.path}),B.enter().append("path").each(function(t){t.source.x0=t.source.x,t.target.x0=t.target.x}).attr("class",function(t){return"category-"+t.major}).attr("d",v),B.sort(function(t,n){return n.count-t.count}),B.exit().remove();var t=G.select(".ribbon-mouse").selectAll("path").data(F,function(t){return t.path});t.enter().append("path").on("mousemove.parsets",function(t){B.classed("active",!1),I||(M(t=t.node,!0),f(j.call(this,t)),d3.event.stopPropagation())}),t.sort(function(t,n){return n.count-t.count}).attr("d",y),t.exit().remove()}function S(t){var n=[t],e=B.filter(function(e){var r,o;return e.source.node===t&&n.push(r=e.source),e.target.node===t&&n.push(o=e.target),r||o}),r=n.map(function(t){return d3.interpolateNumber(t.x0,t.x)}),o=n.length;return function(t){for(var a=0;o>a;a++)n[a].x0=r[a](t);e.attr("d",v)}}function D(t){var n=B.filter(function(n){return n.source.dimension.name==t.name||n.target.dimension.name==t.name}),e=d3.interpolateNumber(t.y0,t.y);return function(r){t.y0=e(r),n.attr("d",v)}}function M(t,n){if(!I){var e=[];if(function r(t){e.push(t);for(var n in t.children)r(t.children[n])}(t),e.shift(),n)for(;t;)e.push(t),t=t.parent;B.filter(function(t){var n=e.indexOf(t.node)>=0;return n&&this.parentNode.appendChild(this),n}).classed("active",!0)}}function T(){I||(B.classed("active",!1),g())}function Z(t){var e=t.selectAll("g.category").data(function(t){return t.categories},function(t){return t.name}),r=e.enter().append("g").attr("class","category").attr("transform",function(t){return"translate("+t.x+")"});e.exit().remove(),e.on("mousemove.parsets",function(t){B.classed("active",!1),I||(t.nodes.forEach(function(t){M(t)}),f(z.call(this,t)),d3.event.stopPropagation())}).on("mouseout.parsets",T).on("mousedown.parsets",n).call(d3.behavior.drag().origin(c).on("dragstart",function(t){I=!0,t.x0=t.x}).on("drag",function(n){n.x=d3.event.x;for(var e=n.dimension.categories,r=0,o=e[0];++r<e.length;)if(o.x+o.dx/2>(o=e[r]).x+o.dx/2){e.sort(function(t,n){return t.x+t.dx/2-n.x-n.dx/2}),F=x(Q,K,H),b(),Z(t),M(n.node),k.sortCategories();break}var a=0,i=L/(e.length-1);e.forEach(function(t){n===t&&(t.x0=d3.event.x),t.x=a,a+=t.count/q*(C-L)+i}),d3.select(this).attr("transform",function(t){return"translate("+t.x0+")"}).transition(),B.filter(function(t){return t.source.node===n||t.target.node===n}).attr("d",v)}).on("dragend",function(t){I=!1,T(),b(),m(d3.select(this)).attr("transform","translate("+t.x+")").tween("ribbon",S)})),e.transition().duration(_).attr("transform",function(t){return"translate("+t.x+")"}).tween("ribbon",S),r.append("rect").attr("width",function(t){return t.dx}).attr("y",-20).attr("height",20),r.append("line").style("stroke-width",2),r.append("text").attr("dy","-.3em"),e.select("rect").attr("width",function(t){return t.dx}).attr("class",function(t){return"category-"+(t.dimension===K[0]?H(t.name):"background")}),e.select("line").attr("x2",function(t){return t.dx}),e.select("text").text(o(function(t){return t.name},function(t){return t.dx}))}var F,q,B,G=d3.select(this),H=d3.scale.ordinal(),I=!1,J=O.call(this,t,i),K=[],Q={children:{},count:0};if(d3.select(window).on("mousemove.parsets."+ ++p,T),null==A&&(A=N),G.selectAll(".ribbon, .ribbon-mouse").data(["ribbon","ribbon-mouse"],String).enter().append("g").attr("class",String),d(),N!=A){var R=d3.transition(G);R.tween?R.tween("ribbon",u):u()(1)}})}function l(t,n){return S.call(this,t.name,n)}function f(t){var n=d3.mouse(D.node());M.style("display",null).style("left",n[0]+30+"px").style("top",n[1]-20+"px").html(t)}function g(){M.style("display","none")}function m(t){return _?t.transition().duration(_).ease(h):t}function x(t,n,e){function r(t,e,a,i){var c=e.node,u=n[a];u.categories.forEach(function(d){var l=d.name;if(c.children.hasOwnProperty(l)){var f=c.children[l];f.path=e.path+"\x00"+l;var h=f.target||{node:d,dimension:u};h.x=d["in"].dx,h.dx=f.count/s*(C-L),d["in"].dx+=h.dx;var p=f.source||{node:t,dimension:n[a-1]};p.x=t.out.dx,p.dx=h.dx,t.out.dx+=p.dx,f.node=f,f.source=p,f.target=h,f.major=i,o.push(f),a+1<n.length&&r(d,f,a+1,i)}})}var o=[],a=n.length,i=45,c=(P-i-2)/(a-1);n.forEach(function(t,n){t.categories.forEach(function(n){n.dimension=t,n.count=0,n.nodes=[]}),t.y=i+n*c});var s=function d(t,e){if(!t.children)return t.count;var r=n[e],o=0;return r.categories.forEach(function(n){var r=t.children[n.name];if(r){n.nodes.push(r);var a=d(r,e+1);n.count+=a,o+=a}}),o}(t,0);n.forEach(function(t){t.categories=t.categories.filter(function(t){return t.count});var n=0,e=L/(t.categories.length-1);t.categories.forEach(function(t){t.x=n,t.dx=t.count/s*(C-L),t["in"]={dx:0},t.out={dx:0},n+=t.dx+e})});var u=n[0];return u.categories.forEach(function(n){var o=n.name;t.children.hasOwnProperty(o)&&r(n,{node:t.children[o],path:o},1,e(o))}),o}function v(t){var n=t.source,e=t.target;return b(n.node.x0+n.x0,n.dimension.y0,n.dx,e.node.x0+e.x0,e.dimension.y0,e.dx,A)}function y(t){var n=t.source,e=t.target;return b(n.node.x+n.x,n.dimension.y,n.dx,e.node.x+e.x,e.dimension.y,e.dx,N)}function b(t,n,e,r,o,a,i){var c,s;return(1===i?["M",[t,n],"L",[r,o],"h",a,"L",[t+e,n],"Z"]:["M",[t,n],"C",[t,c=i*n+(1-i)*o]," ",[r,s=i*o+(1-i)*n]," ",[r,o],"h",a,"C",[r+a,s]," ",[t+e,c]," ",[t+e,n],"Z"]).join("")}function w(t,n){return t=P*t.y,n=P*n.y,n>t?-1:t>n?1:t>=n?0:t>=t?-1:n>=n?1:0/0}var E,C,P,A,k=d3.dispatch("sortDimensions","sortCategories"),O=t,S=String,j=u,z=d,L=20,N=1,_=500;i.dimensionFormat=function(t){return arguments.length?(S=t,i):S},i.dimensions=function(t){return arguments.length?(O=d3.functor(t),i):O},i.value=function(t){return arguments.length?(E=d3.functor(t),i):E},i.width=function(t){return arguments.length?(C=+t,i):C},i.height=function(t){return arguments.length?(P=+t,i):P},i.spacing=function(t){return arguments.length?(L=+t,i):L},i.tension=function(t){return arguments.length?(N=+t,i):N},i.duration=function(t){return arguments.length?(_=+t,i):_},i.tooltip=function(t){return arguments.length?(j=null==t?u:t,i):M},i.categoryTooltip=function(t){return arguments.length?(z=null==t?d:t,i):z};var D=d3.select("body"),M=D.append("div").style("display","none").attr("class","parsets tooltip");return d3.rebind(i,k,"on").value(1).width(960).height(600)},d3.parsets.tree=a;var l=d3.format("%"),f=d3.format(",f"),h="elastic",p=0}();
