<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Obesity by state, 2013: a CartoDB state squares experiment  &middot; KYLE WALKER DATA</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="Obesity by state, 2013: a CartoDB state squares experiment  &middot; KYLE WALKER DATA ">
<meta property="og:site_name" content="KYLE WALKER DATA"/>
<meta property="og:url" content="/2015/05/obesity-squares/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2015-05-09T00:00:00Z" />
<meta property="og:article:modified_time" content="2015-05-09T00:00:00Z" />

  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@kyle_e_walker" />
<meta name="twitter:creator" content="@kyle_e_walker" />
<meta name="twitter:title" content="Obesity by state, 2013: a CartoDB state squares experiment" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="/2015/05/obesity-squares/" />
<meta name="twitter:domain" content="/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Obesity by state, 2013: a CartoDB state squares experiment",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2015-05-09",
    "description": "",
    "wordCount":  491 
  }
</script>



<link rel="canonical" href="../../../2015/05/obesity-squares/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../touch-icon-144-precomposed.png">
<link href="../../../favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.17" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="../../../css/font-awesome.min.css">
<link rel="stylesheet" href="../../../css/style.css">
<link rel="stylesheet" href="../../../css/highlight/zenburn.css">

  <!DOCTYPE HTML>
<style>
  
  .main_wrapper>.main_header {
    background-color: #035004;
    color: #fff;
  }
  
  .main_wrapper>.main_content .label:hover,
  .main_wrapper>.main_content .navigation a:hover,
  .main_wrapper>.main_content .pagination a:hover,
  .main_wrapper>.main_content .readlink a:hover,
  .main_wrapper>.main_content h2 a:hover,
  .main_wrapper>.main_header a:hover {
    background-color: #035004;
    color: #fff;
    text-decoration: none; 
}

  a {
    color: #1a730f; 
  }
  
  a:active, a:focus, a:hover {
    color: #035004;
}
  
</style>







</head>
<body class="map[name:superhero]">
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="../../../">
  KYLE WALKER DATA

</a>

</div>

  
<div class="container topline">
  
  Writing about visualization, demographics, dashboards, and spatial data science. <br/><br/>Interested in learning more?  Hire me for a workshop or to consult on your next project.  See the Services page for more details.


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="../../../about">About</a>

<a href="../../../post" title="Show list of posts">Posts</a>

<a href="../../../tags" title="Show list of tags">Tags</a>

<a href="../../../services">Services</a>

<a href="https://www.r-bloggers.com/">R-Bloggers</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:kwalkerdata@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/walkerke">
  <span class="fa fa-github-square"></span><span>github</span></a>





<a id="contact-link-linkedin" class="contact_link" href="https://www.linkedin.com/in/walkerke">
  <span class="fa fa-linkedin-square"></span><span>linkedin</span></a>







<a id="contact-link-twitter" class="contact_link" href="https://twitter.com/kyle_e_walker">
  <span class="fa fa-twitter-square"></span><span>twitter</span></a>













</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Obesity by state, 2013: a CartoDB state squares experiment
</h1>

  <div class="metas">
<time datetime="2015-05-09">9 May, 2015</time>


  
    &middot; by Kyle Walker
  
  &middot; Read in about 3 min
  &middot; (491 Words)
  <br>
  


</div>

</header>

  <div class="container content">


<p>In this document, I will demonstrate how I created an interactive CartoDB state squares map of obesity in the United States for 2013. Credit is due to <a href="https://twitter.com/billdollins">Bill Dollins</a> for sharing a state squares file in GeoJSON format. You can access the file from his <a href="https://github.com/geobabbler/us-state-squares">GitHub repository</a>. The data processing is done in R, and the visualization is done with the CartoDB web GUI.</p>
<p>The workflow below uses the <a href="https://github.com/walkerke/kwgeo">kwgeo</a> R package to upload data directly to CartoDB. As this package is intended for personal use, it may not meet your needs. If this is the case, the workflow (aside from the uploading, which you’ll have to do manually) can be reproduced by replacing <code>kwgeo</code> with the <code>rgdal</code> package.<br />
To get started, let’s load the packages and data, which I’ve downloaded from Bill’s repository.</p>
<pre class="r"><code>library(kwgeo)
library(rvest)
library(dplyr)

squares &lt;- readOGR(&quot;state_squares.geojson&quot;, &quot;OGRGeoJSON&quot;, verbose = FALSE)

plot(squares)</code></pre>
<p><img src="figures/unnamed-chunk-1-1.png" width="672" /></p>
<p>Now, I need to fetch obesity data from the <a href="http://nccd.cdc.gov/NPAO_DTM/IndicatorSummary.aspx?category=28&amp;indicator=29">CDC website</a>. The scraped table has a couple elements that need to be cleaned up, so I’ll do that below.</p>
<pre class="r"><code>url &lt;- &quot;http://nccd.cdc.gov/NPAO_DTM/IndicatorSummary.aspx?category=28&amp;indicator=29&quot;

df &lt;- url %&gt;%
  html() %&gt;%
  html_nodes(&quot;table&quot;) %&gt;%
  html_table(fill = TRUE) %&gt;%
  data.frame() 

df_fixed &lt;- df %&gt;%
  select(name = Location.Type, obesity = Location) %&gt;%
  filter(!(name %in% c(&quot;National&quot;, &quot;Territories&quot;))) %&gt;%
  mutate(name = ifelse(name == &quot;States&quot;, &quot;Alabama&quot;, name), 
         obesity = ifelse(obesity == &quot;Alabama&quot;, &quot;32.4&quot;, obesity)) %&gt;%
  mutate(obesity = as.numeric(obesity))</code></pre>
<p>I then merge the squares data with my obesity data, and upload to CartoDB with my <a href="http://rpubs.com/walkerke/r2cartodb">r2cartodb</a> function.</p>
<pre class="r"><code>merged_squares &lt;- sp::merge(squares, df_fixed, by = &quot;name&quot;, sort = FALSE)

my_account_id = &quot;kwalkertcu&quot;

my_api_key = &quot;not_sharing_this&quot;

r2cartodb(merged_squares, &quot;obesity_squares&quot;, my_account_id, my_api_key)</code></pre>
<p>I then head to CartoDB to style my data with its web GUI. However, there are a couple steps I need to take to display the data as squares, given that the default is to project my data in Web Mercator. First, I change the basemap to a white background, given that my data aren’t designed to align with a pre-designed basemap. Next, I project my data using CartoDB’s SQL pane so that my states appear as squares, rather than rectangles. I use <a href="http://spatialreference.org/ref/epsg/32662/">an equirectangular (Plate Carree) projection</a> to get this done, which can be accomplished with the following SQL:</p>
<pre class="sql"><code>SELECT 

cartodb_id, obesity, name, abbr, 

ST_Transform(the_geom, 32662) the_geom_webmercator

FROM obesity_squares</code></pre>
<p>I then apply some styling, creating a 5-class quantile choropleth based on the <code>obesity</code> field from the “wizards” tab. I also label the squares with the <code>abbr</code> field, setting the “Label Offset” to <code>0</code> to center the labels. I then add a tooltip to appear on hover that gives information about obesity in each state. Here is the result!</p>
<iframe width="100%" height="600" frameborder="0" src="https://kwalkertcu.cartodb.com/viz/661c6e38-f63b-11e4-9085-0e853d047bba/embed_map" allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen>
</iframe>
<p>Pan and zoom to explore the state squares map. What this demonstrates, I think, is that CartoDB can be used for visualizations of all types, not just maps, so long as you get the coordinates and projection right - as exemplified by <a href="http://graphics.latimes.com/pop-music-evolution/">this recent visualization from the LA Times</a>.</p>
<p>If you have any comments or questions, please let me know!</p>




</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="../../../2015/03/custom_tiles/" title="Using custom tiles in an RStudio Leaflet map">
      Previous
    </a>
    

    
    <a class="next" href="../../../2015/12/roads-tigris/" title="Fetching roads data in R with tigris">
      Next
    </a>
    

  


</div>

  

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  
<div class="container copyright">
  
  &copy; 2017 Kyle Walker


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="../../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51388803-1', 'auto');
  ga('send', 'pageview');

</script>


    
  </body>
</html>

